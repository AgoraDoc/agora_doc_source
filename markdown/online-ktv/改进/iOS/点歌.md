## 简介

本文介绍如何实现点歌功能。用户需要在 K 歌之前进行点歌。点歌指用户通过浏览或搜索正版音乐，选定心仪的音乐，然后下载播放。音乐开始播放后，参与 K 歌的用户可以开始唱歌。

## 示例项目

声网在 GitHub 上提供开源的 //TODO 示例项目供你参考。

## 准备开发环境

## 前提条件

- Xcode 12.0 或以上版本。
- iOS 11.0 或以上版本的真机设备。
- 有效的[声网开发者账号](/cn/Agora%20Platform/sign_in_and_sign_up?platform=iOS)。
- 有效的声网项目，并获取项目的 App ID 和 RTM Token。详情请参考[开始使用 Agora 平台](/cn/Agora%20Platform/get_appid_token?platform=All%20Platforms)。
- 联系 sales@agora.io 申请开通声网正版音乐内容中心服务。

<div class="alert note"><li>模拟器可能无法运行在线 K 歌房的全部功能，因此声网推荐你在真机上运行 K 歌房项目。</li><li>如果你的网络环境部署了防火墙，请参考<a href="/cn/AgoraPlatform/firewall?platform=iOS">应用企业防火墙限制</a>以正常使用声网服务。</li></div>

### 创建项目

参考以下步骤创建一个 iOS 项目。

<details>
	<summary><font color="#3ab7f8">创建 iOS 项目</font></summary>

1. 打开 **Xcode** 并点击 **Create a new Xcode project**。
2. 选择项目类型为 **Single View App**，并点击 **Next**。
3. 输入项目信息，如项目名称、开发团队信息、组织名称和语言，并点击 **Next**。

	**Note**：如果你没有添加过开发团队信息，会看到 **Add account…** 按钮。点击该按钮并按照屏幕提示登入 Apple ID，完成后即可选择你的账户作为开发团队。
4. 选择项目存储路径，并点击 **Create**。
5. 将你的 iOS 设备连接至电脑。
6. 进入 **TARGETS > Project Name > Signing & Capabilities** 菜单，选择 **Automatically manage signing**，并在弹出菜单中点击 **Enable Automatic**。
</details>

### 集成 SDK

在线 K 歌房需要集成声网的两个 SDK：

- 音频 SDK：主要提供在线音频互动、音频管理（例如调节本地麦克风采集的歌声音量、混合用户歌声和背景音乐声、获取本地歌声的音高值）、NTP 时间戳同步功能。
- 歌词组件：主要提供歌词文本和标准音高线随音乐播放而同步展示、用户音准评分功能。

下节介绍如何使用 Cocoapods 集成 SDK：

1. 开始前确保你已安装 Cocoapods。参考 [Getting Started with CocoaPods](https://guides.cocoapods.org/using/getting-started.html#getting-started) 安装说明。

2. 在终端里进入项目根目录，并运行 `pod init` 命令。项目文件夹下会生成一个 `Podfile` 文本文件。

3. 打开 `Podfile` 文件，修改文件为如下内容。注意将 `Your App` 替换为你的 Target 名称。

    ```ruby
    target 'Your App' do
        pod 'AgoraAudio_iOS', '~> 4.0.1'
        pod 'AgoraLyricsScore', '~> 1.0.8'
    end
    ```

    示例代码中的版本号仅供参考。音频 SDK 最新版本号详见[发版说明](/cn/voice-call-4.x/release_ios_audio_ng?platform=iOS)。歌词组件最新版本号详见 [GitHub Tags](https://github.com/AgoraIO-Community/LrcView-iOS/tags)。


4. 在终端内运行 `pod install` 命令安装 SDK。成功安装后，Terminal 中会显示 `Pod installation complete!`，此时项目文件夹下会生成一个 `xcworkspace` 文件。

5. 打开新生成的 `xcworkspace` 文件。

## 实现方法

//TODO pic

### 1. 初始化音乐内容中心

调用 sharedContentCenterWithConfig 初始化声网正版音乐内容中心。音乐内容AgoraMusicContentCenterConfiguration 中需要传入用户账号和 RTM Token xxx

提供用户的RTM账号与RTM Token，如何生成请查看xxx

```objective-c
AgoraMusicContentCenterConfig *contentCenterConfiguration = [[AgoraMusicContentCenterConfig alloc] init];
contentCenterConfiguration.rtcEngine = self.RTCkit;
contentCenterConfiguration.appId = [[AppContext shared] appId];
contentCenterConfiguration.mccUid = [VLUserCenter.user.id integerValue];
contentCenterConfiguration.token = VLUserCenter.user.agoraRTMToken;
self.AgoraMcc = [AgoraMusicContentCenter sharedContentCenterWithConfig:contentCenterConfiguration];
```

### 2. 创建音乐播放器

通过createMusicPlayerWithDelegate创建曲库专用的MusicPlayer，delegate传入的对象可以用来监听播放器相关的事件。

```objective-c
self.rtcMediaPlayer = [self.AgoraMcc createMusicPlayerWithDelegate:[AppContext shared]];
```

### 3. 获取歌曲

使用searchMusicWithKeyWord基于关键词搜索歌曲，或使用getMusicCollectionWithMusicChartId基于榜单获取歌曲，获取的结果可以按需进行分页，内容包含歌手，专辑封面，歌词类型，歌曲长度等。

关键词搜索

```
- (void)searchWithKeyWord:(NSString*)keyWord{
    self.requestId = [self.AgoraMcc searchMusicWithKeyWord:keyWord
                                                    page:self.page
                                                pageSize:5
                                              jsonOption:nil];
}
- (void)onMusicCollectionResult:(NSString *)requestId
                         status:(AgoraMusicContentCenterStatusCode)status
                         result:(AgoraMusicCollection *)result {
    if (![self.requestId isEqualToString:requestId]) {
        return;
    }
    //extra operations
    ...
}
```

榜单获取
```
-(void)searchWithKeyWord:(NSString*)keyWord{
    self.requestId = [self.AgoraMcc getMusicCollectionWithMusicChartId:chartId
                                                                    page:self.page
                                                                pageSize:20
                                                              jsonOption:nil];
}

- (void)onMusicCollectionResult:(NSString *)requestId
                         status:(AgoraMusicContentCenterStatusCode)status
                         result:(AgoraMusicCollection *)result {
    if (![self.requestId isEqualToString:requestId]) {
        return;
    }
    //extra operations
    ...
}
```

### 4. 下载播放音乐

使用preloadWithSongCode接口预加载歌曲资源，可以预先通过isPreloadedWithSongCode确认歌曲是否已在本地下载过，若已下载过则可以直接跳过preload过程。

通过openMediaWithSongCode加载下载完成的音乐，等待player的回调以确认歌曲加载完成。

加载完成后就可以调用player的play接口进行音乐的播放。

## API 参考

如需了解更多点歌相关的 API，请参考[音频 SDK 版权音乐 API 说明](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html)。



- [sharedContentCenterWithConfig](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusiccontentcenter_initialize)
- [createMusicPlayerWithDelegate](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusiccontentcenter_createmusicplayer)
- [searchMusicWithKeyWord](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusiccontentcenter_searchmusic)
- [getMusicCollectionWithMusicChartId](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusiccontentcenter_getmusiccollectionbymusicchartid)
- [isPreloadedWithSongCode](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusiccontentcenter_ispreloaded)
- [preloadWithSongCode](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusicontentcenter_preload)
- [openMediaWithSongCode](https://docs.agora.io/cn/voice-call-4.x/API%20Reference/ios_ng/API/toc_drm.html?platform=iOS#api_imusicplayer_open)